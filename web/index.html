<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pine Script Library</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üìà Pine Script Library</h1>
                    <p class="subtitle">TradingView Scripts Collection</p>
                </div>
                <button class="btn btn-secondary" onclick="openSettingsModal()" style="height: fit-content;">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </header>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search scripts by name, description, or tags...">
                <button class="btn btn-create" onclick="openEditModal()">+ Create New Script</button>
            </div>
            
            <div class="filters">
                <label>
                    <span>Type:</span>
                    <select id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="strategy">Strategies</option>
                        <option value="indicator">Indicators</option>
                        <option value="study">Studies</option>
                    </select>
                </label>
                
                <label>
                    <span>Status:</span>
                    <select id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="testing">Testing</option>
                        <option value="deprecated">Deprecated</option>
                        <option value="archived">Archived</option>
                    </select>
                </label>
                
                <label>
                    <span>Sort By:</span>
                    <select id="sortBy">
                        <option value="name">Name</option>
                        <option value="dateModified">Last Modified</option>
                        <option value="winRate">Win Rate</option>
                        <option value="profitFactor">Profit Factor</option>
                        <option value="netProfitPercent">Net Profit %</option>
                    </select>
                </label>
            </div>
        </div>

        <div class="table-container">
            <table id="scriptsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Version</th>
                        <th>Status</th>
                        <th>Tags</th>
                        <th class="metric">Win Rate</th>
                        <th class="metric">Profit Factor</th>
                        <th class="metric">Net Profit %</th>
                        <th class="metric">Max DD %</th>
                        <th class="metric">Total Trades</th>
                        <th>Last Modified</th>
                        <th style="min-width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="scriptsTableBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div id="noResults" class="no-results" style="display: none;">
            <p>No scripts found matching your criteria.</p>
        </div>

        <div id="scriptModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="modalBody">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="codeModal" class="modal">
            <div class="modal-content modal-code">
                <span class="close" onclick="closeCodeModal()">&times;</span>
                <div id="codeModalHeader" class="code-modal-header">
                    <h2 id="codeModalTitle">Pine Script Code</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="reviewCode()">
                            <span id="reviewButtonText">üîç Code Review</span>
                        </button>
                        <button class="btn btn-secondary" id="editCodeButton" onclick="toggleEditMode()">
                            <span id="editButtonText">‚úèÔ∏è Edit</span>
                        </button>
                        <button class="btn btn-success" id="saveCodeButton" onclick="saveEditedCode()" style="display: none;">
                            <span id="saveButtonText">üíæ Save</span>
                        </button>
                        <button class="btn btn-secondary" id="cancelEditButton" onclick="cancelEditMode()" style="display: none;">
                            Cancel
                        </button>
                        <button class="btn btn-primary" id="copyCodeButton" onclick="copyCode()">
                            <span id="copyButtonText">üìã Copy Code</span>
                        </button>
                    </div>
                </div>
                <div class="code-info" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                    <span id="codeFilePath"></span>
                    <div id="codeVersionSelect" style="display: none;"></div>
                </div>
                <div class="code-container">
                    <pre id="codeDisplay"><code id="codeContent" class="language-pinescript"></code></pre>
                    <textarea id="codeEditor" class="code-editor" style="display: none;"></textarea>
                </div>
            </div>
        </div>

        <div id="reviewModal" class="modal">
            <div class="modal-content modal-review">
                <span class="close" onclick="closeReviewModal()">&times;</span>
                <div class="review-modal-header">
                    <h2>üìã Code Review Report</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="autoFixCode()" id="autoFixBtn" style="display: none;">
                            <span id="autoFixButtonText">üîß Quick Fix</span>
                        </button>
                        <button class="btn btn-success" onclick="smartAutoFixCode()" id="smartAutoFixBtn" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <span id="smartAutoFixButtonText">‚ú® Smart Fix (LLM)</span>
                        </button>
                        <button class="btn btn-primary" onclick="exportReviewToPDF()" id="exportPdfBtn" style="display: none;">
                            <span id="exportButtonText">üìÑ Export PDF</span>
                        </button>
                    </div>
                </div>
                <div id="reviewModalBody">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content modal-form">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <h2 id="editModalTitle">Create New Script</h2>
                
                <form id="editForm" onsubmit="handleFormSubmit(event)">
                    <div class="form-grid">
                        <div class="form-section">
                            <h3>Basic Information</h3>
                            
                            <div class="form-group">
                                <label for="edit_name">Name *</label>
                                <input type="text" id="edit_name" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit_type">Type *</label>
                                    <select id="edit_type" required>
                                        <option value="indicator">Indicator</option>
                                        <option value="strategy">Strategy</option>
                                        <option value="study">Study</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit_version">Version *</label>
                                    <input type="text" id="edit_version" value="1.0.0" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit_status">Status</label>
                                    <select id="edit_status">
                                        <option value="active">Active</option>
                                        <option value="testing">Testing</option>
                                        <option value="deprecated">Deprecated</option>
                                        <option value="archived">Archived</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_filePath">
                                    File Path *
                                    <small style="color: var(--text-secondary); font-weight: normal; margin-left: 8px;">
                                        (auto-generated from name and type)
                                    </small>
                                </label>
                                <input type="text" id="edit_filePath" placeholder="Auto-generated: scripts/indicators/my-script.pine" required>
                                <small style="display: block; margin-top: 6px; color: var(--text-secondary); font-style: italic;">
                                    üí° Example: "My RSI Strategy" ‚Üí scripts/strategies/my-rsi-strategy.pine
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_description">Description</label>
                                <textarea id="edit_description" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_author">Author</label>
                                <input type="text" id="edit_author">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_tags">Tags (comma-separated)</label>
                                <input type="text" id="edit_tags" placeholder="trend, momentum, rsi">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_timeframes">Timeframes (comma-separated)</label>
                                <input type="text" id="edit_timeframes" placeholder="1h, 4h, 1D">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_notes">Notes</label>
                                <textarea id="edit_notes" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Backtest Metrics (Optional)</h3>
                            <p class="form-hint">Fill in if this is a strategy with backtest results</p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit_bt_symbol">Symbol</label>
                                    <input type="text" id="edit_bt_symbol" placeholder="BTCUSD">
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit_bt_timeframe">Timeframe</label>
                                    <input type="text" id="edit_bt_timeframe" placeholder="4h">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit_bt_netProfitPercent">Net Profit %</label>
                                    <input type="number" id="edit_bt_netProfitPercent" step="0.01" placeholder="24.51">
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit_bt_totalTrades">Total Trades</label>
                                    <input type="number" id="edit_bt_totalTrades" placeholder="45">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit_bt_winRate">Win Rate %</label>
                                    <input type="number" id="edit_bt_winRate" step="0.01" placeholder="62.22">
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit_bt_profitFactor">Profit Factor</label>
                                    <input type="number" id="edit_bt_profitFactor" step="0.01" placeholder="1.85">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_bt_maxDrawdown">Max Drawdown %</label>
                                <input type="number" id="edit_bt_maxDrawdown" step="0.01" placeholder="-12.5">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Script</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Settings Modal for API Keys -->
        <div id="settingsModal" class="modal">
            <div class="modal-content modal-form" style="max-width: 600px;">
                <span class="close" onclick="closeSettingsModal()">&times;</span>
                <h2>‚öôÔ∏è Settings</h2>
                
                <div class="form-section">
                    <h3>ü§ñ LLM API Configuration</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">
                        Configure your API key to enable Smart Auto-Fix powered by AI. Your key is stored securely in your browser only.
                    </p>
                    
                    <div class="form-group">
                        <label for="llmProvider">LLM Provider</label>
                        <select id="llmProvider" onchange="updateApiKeyPlaceholder()">
                            <option value="openai">OpenAI (GPT-4)</option>
                            <option value="claude" disabled>Anthropic Claude (Coming Soon)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="apiKeyInput">
                            API Key
                            <small style="color: var(--text-secondary); font-weight: normal; margin-left: 8px;">
                                (stored locally in browser)
                            </small>
                        </label>
                        <input type="password" id="apiKeyInput" placeholder="sk-...">
                        <small style="display: block; margin-top: 6px; color: var(--text-secondary);">
                            <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--accent-color);">
                                üîó Get your OpenAI API key here
                            </a>
                        </small>
                    </div>
                    
                    <div class="form-group" style="background: var(--hover-bg); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent-color);">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="useServerKey" onchange="toggleApiKeyInput()">
                            <span>Use server-configured API key (if available)</span>
                        </label>
                        <small style="display: block; margin-top: 8px; color: var(--text-secondary); margin-left: 24px;">
                            If your administrator has configured a server-side API key, you can use it instead of providing your own.
                        </small>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,193,7,0.1); border-radius: 8px; border-left: 3px solid #ffc107;">
                        <strong style="color: #ffc107;">‚ö†Ô∏è Security Note:</strong>
                        <ul style="margin: 10px 0 0 20px; color: var(--text-secondary); font-size: 13px;">
                            <li>Your API key is stored only in your browser's localStorage</li>
                            <li>It is never saved to the server or any database</li>
                            <li>Transmitted over HTTPS to the LLM provider only</li>
                            <li>Keep your API key confidential</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="clearApiKey()">Clear Key</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/pine-highlight.js"></script>
</body>
</html>
