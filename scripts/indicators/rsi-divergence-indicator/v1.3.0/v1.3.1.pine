// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Your Name

//@version=5
indicator("RSI Divergence Detector", overlay=true)

// ============================================================================
// DESCRIPTION
// ============================================================================
// Automatically detects bullish and bearish divergences between price and RSI.
// Marks divergences on the chart with lines and labels for easy identification.
//
// AUTHOR: Your Name
// Version: v1.3.1
// DATE: 2026-01-08
//
// PARAMETERS:
// - rsiLengthInput: Period for RSI calculation (default: 14)
// - pivotLookbackInput: Bars to look back/forward for pivot detection (default: 5)
// - showRsiPanelInput: Display RSI in a separate panel (default: true)
//
// DIVERGENCE TYPES:
// - Bullish Regular: Price makes lower low, RSI makes higher low (reversal signal)
// - Bearish Regular: Price makes higher high, RSI makes lower high (reversal signal)
// - Bullish Hidden: Price makes higher low, RSI makes lower low (continuation signal)
// - Bearish Hidden: Price makes lower high, RSI makes higher high (continuation signal)
//
// USAGE:
// Best used on higher timeframes (1H, 4H, Daily) to reduce false signals.
// Confirm divergences with other indicators or price action.
// ============================================================================

// ————— Constants
const color BULL_REGULAR_COLOR  = #00FF00ff
const color BEAR_REGULAR_COLOR  = #FF0000ff
const color BULL_HIDDEN_COLOR   = #0000FFff
const color BEAR_HIDDEN_COLOR   = #FF8000ff
const color RSI_COLOR           = #800080ff
const color OVERBOUGHT_COLOR    = #FF0000ff
const color OVERSOLD_COLOR      = #00FF00ff
const color MIDLINE_COLOR       = #808080ff
const color BG_OVERBOUGHT       = color.new(#FF0000ff, 90)
const color BG_OVERSOLD         = color.new(#00FF00ff, 90)

const int   RSI_OVERBOUGHT      = 70
const int   RSI_OVERSOLD        = 30
const int   RSI_MIDLINE         = 50

const string BULL_DIV_TEXT      = "Bull Div"
const string BEAR_DIV_TEXT      = "Bear Div"
const string BULL_HIDDEN_TEXT   = "Bull HD"
const string BEAR_HIDDEN_TEXT   = "Bear HD"

// ————— Inputs
int  rsiLengthInput       = input.int(14, "RSI Length", minval=1)
int  pivotLookbackInput   = input.int(5, "Pivot Lookback", minval=1)
bool showRsiPanelInput    = input.bool(true, "Show RSI Panel")

// ————— Calculations
// RSI Calculation
float rsiValue = ta.rsi(close, rsiLengthInput)

// Pivot Detection - Price
float pivotHighPrice = ta.pivothigh(high, pivotLookbackInput, pivotLookbackInput)
float pivotLowPrice = ta.pivotlow(low, pivotLookbackInput, pivotLookbackInput)

// Pivot Detection - RSI
float rsiPivotHigh = ta.pivothigh(rsiValue, pivotLookbackInput, pivotLookbackInput)
float rsiPivotLow = ta.pivotlow(rsiValue, pivotLookbackInput, pivotLookbackInput)

// Variables to store pivot values and bars
var float lastPivotHigh = na
var float lastPivotLow = na
var float lastRsiPivotHigh = na
var float lastRsiPivotLow = na
var int lastPivotHighBar = na
var int lastPivotLowBar = na

// Update pivot values
if not na(pivotHighPrice)
  lastPivotHigh := pivotHighPrice
  lastPivotHighBar := bar_index - pivotLookbackInput

if not na(pivotLowPrice)
  lastPivotLow := pivotLowPrice
  lastPivotLowBar := bar_index - pivotLookbackInput

if not na(rsiPivotHigh)
  lastRsiPivotHigh := rsiPivotHigh

if not na(rsiPivotLow)
  lastRsiPivotLow := rsiPivotLow

// Detect Divergences - Only after sufficient data
bool sufficientData = bar_index >= pivotLookbackInput * 2

bool bullishRegular = sufficientData and not na(pivotLowPrice) and not na(lastPivotLow) and 
  pivotLowPrice > lastPivotLow and rsiPivotLow < lastRsiPivotLow

bool bearishRegular = sufficientData and not na(pivotHighPrice) and not na(lastPivotHigh) and 
  pivotHighPrice < lastPivotHigh and rsiPivotHigh > lastRsiPivotHigh

bool bullishHidden = sufficientData and not na(pivotLowPrice) and not na(lastPivotLow) and 
  pivotLowPrice < lastPivotLow and rsiPivotLow > lastRsiPivotLow

bool bearishHidden = sufficientData and not na(pivotHighPrice) and not na(lastPivotHigh) and 
  pivotHighPrice > lastPivotHigh and rsiPivotHigh < lastRsiPivotHigh

// ————— Visuals
// Plot RSI Panel (optional)
plot(showRsiPanelInput ? rsiValue : na, "RSI", 
  color=RSI_COLOR, 
  linewidth=2)

// RSI Levels
hline(RSI_OVERBOUGHT, "Overbought", 
  color=OVERBOUGHT_COLOR, 
  linestyle=hline.style_dashed)
hline(RSI_OVERSOLD, "Oversold", 
  color=OVERSOLD_COLOR, 
  linestyle=hline.style_dashed)
hline(RSI_MIDLINE, "Midline", 
  color=MIDLINE_COLOR, 
  linestyle=hline.style_dotted)

// Divergence Signals 2
plotshape(bullishRegular, "Bullish Regular Divergence", 
  shape.labelup, 
  location.belowbar, 
  color=color.new(BULL_REGULAR_COLOR, 0), 
  text=BULL_DIV_TEXT, 
  textcolor=color.white, 
  size=size.small)

plotshape(bearishRegular, "Bearish Regular Divergence", 
  shape.labeldown, 
  location.abovebar, 
  color=color.new(BEAR_REGULAR_COLOR, 0), 
  text=BEAR_DIV_TEXT, 
  textcolor=color.white, 
  size=size.small)

plotshape(bullishHidden, "Bullish Hidden Divergence", 
  shape.labelup, 
  location.belowbar, 
  color=color.new(BULL_HIDDEN_COLOR, 0), 
  text=BULL_HIDDEN_TEXT, 
  textcolor=color.white, 
  size=size.tiny)

plotshape(bearishHidden, "Bearish Hidden Divergence", 
  shape.labeldown, 
  location.abovebar, 
  color=color.new(BEAR_HIDDEN_COLOR, 0), 
  text=BEAR_HIDDEN_TEXT, 
  textcolor=color.white, 
  size=size.tiny)

// Background coloring for RSI overbought/oversold
bgcolor(showRsiPanelInput and rsiValue > RSI_OVERBOUGHT ? BG_OVERBOUGHT : na)
bgcolor(showRsiPanelInput and rsiValue < RSI_OVERSOLD ? BG_OVERSOLD : na)

// ————— Alerts
alertcondition(bullishRegular, "Bullish Regular Divergence", 
  "Bullish Regular Divergence detected!")
alertcondition(bearishRegular, "Bearish Regular Divergence", 
  "Bearish Regular Divergence detected!")
alertcondition(bullishHidden, "Bullish Hidden Divergence", 
  "Bullish Hidden Divergence detected!")
alertcondition(bearishHidden, "Bearish Hidden Divergence", 
  "Bearish Hidden Divergence detected!")
